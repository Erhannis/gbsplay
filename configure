#!/bin/sh
# $Id: configure,v 1.9 2003/09/19 18:51:42 mitch Exp $
#
# generate config.mk for gbsplay Makefile
#
# 2003 (C) by Christian Garbs <mitch@cgarbs.de>
#             Tobias Diedrich <ranma@gmx.at>
# Licensed under GNU GPL.

EXTRA_ALL=
EXTRA_CFLAGS=
EXTRA_INSTALL=
EXTRA_LDFLAGS=
EXTRA_SRCS=
EXTRA_UNINSTALL=
XMMS_INPUT_PLUGIN_DIR=
ZLIB_FOUND=

build_xmmsplugin=n

## enable logging of errors

ERRORLOG=config.err
exec 2> $ERRORLOG

## check for C compiler

echo -n "checking for CC:  "
if [ $CC ]; then
    echo "ok"
else
    echo "nok"
    cat <<EOF
Environment variable CC is not set.
Pleasy point it to a working C compiler.
You probably want to run 'make' instead of './configure'.
EOF
    exit 1
fi

echo -n "checking for working compiler:  "
INFILE=$(mktemp).c
OUTFILE=$(mktemp)

cat > "$INFILE" <<EOF
int main(char argc, char **argv) {
    return 0;
}
EOF
$CC -o "$OUTFILE" "$INFILE"
RESULT=$?
rm -f "$INFILE"
if [ $RESULT -eq 0 ]; then
    if [ -s "$OUTFILE" ]; then
	"$OUTFILE"
	rm -f "$OUTFILE"
	if [ $? -eq 0 ]; then
	    echo "ok"
	else
	    echo "can't execute generated code"
	    exit 1
	fi
    else
	rm -f "$OUTFILE"
	echo "no code generated"
	exit 1
    fi
else
    echo "error executing $CC"
    exit 1
fi


## check for glib development files

echo -n "checking for glib-dev:  "
CONFIG=`which glib-config`
if [ $? -eq 0 ]; then
    GLIB_CFLAGS=`glib-config --cflags`
    if [ $? -eq 0 ]; then
	echo "ok"
    else
	echo "error running glib-config --cflags!"
    fi
else
    echo "glib-config not found!"
fi

## check for xmms development files

echo -n "checking for xmms-dev:  "
CONFIG=`which xmms-config`
if [ $? -eq 0 ]; then
    XMMS_CFLAGS=`xmms-config --cflags` 
    if [ $? -eq 0 ]; then
	XMMS_INPUT_PLUGIN_DIR=`xmms-config --input-plugin-dir`
	if [ $? -eq 0 ]; then
	    echo "ok"
	else
	    echo "error running xmms-config --input-plugin-dir!"
	fi
    else
	echo "error running xmms-config --cflags!"
    fi
else
    echo "xmms-config not found!"
fi

## check for zlib development files

echo -n "checking for zlib-dev:  "

INFILE=$(mktemp).c
OUTFILE=$(mktemp)

cat > "$INFILE" <<EOF
#include <zlib.h>
int main(char argc, char **argv) {
    return 0;
}
EOF
$CC -o "$OUTFILE" "$INFILE"
if [ $? -eq 0 ]; then
    ZLIB_FOUND=yes
    echo "ok"
else
    echo "not found"
fi
rm -f "$INFILE" "$OUTFILE"

## everything ok?

if [ "$GLIB_CFLAGS" -a "$XMMS_CFLAGS" -a "XMMS_INPUT_PLUGIN_DIR" ]; then
    EXTRA_CFLAGS="$EXTRA_CFLAGS $GLIB_CFLAGS $XMMS_CFLAGS"
    EXTRA_INSTALL="$EXTRA_INSTALL install-gbsxmms.so"
    EXTRA_UNINSTALL="$EXTRA_UNINSTALL uninstall-gbsxmms.so"
    build_xmmsplugin=y
    echo "xmms support enabled."
else
    echo "no xmms support."
fi

if [ "$ZLIB_FOUND" = "yes" ]; then
    EXTRA_CFLAGS="$EXTRA_CFLAGS -DHAVE_ZLIB"
    EXTRA_LDFLAGS="$EXTRA_LDFLAGS -lz"
    echo "crc32 support enabled."
else
    echo "no crc32 support."
fi

## write configuration

(
    echo EXTRA_ALL := $EXTRA_ALL
    echo EXTRA_CFLAGS := $EXTRA_CFLAGS 
    echo EXTRA_INSTALL := $EXTRA_INSTALL
    echo EXTRA_LDFLAGS := $EXTRA_LDFLAGS
    echo EXTRA_SRCS := $EXTRA_SRCS
    echo EXTRA_UNINSTALL := $EXTRA_UNINSTALL
    echo XMMS_INPUT_PLUGIN_DIR := $XMMS_INPUT_PLUGIN_DIR
    echo build_xmmsplugin := $build_xmmsplugin
) > config.mk

(
    if [ -f CVS/Entries ]; then
	echo "#define GBS_VERSION \"CVS `date -r CVS/Entries`\""
    else
	echo "#define GBS_VERSION \"0.0.2-dev\""
    fi
) > config.h

## end

test -s $ERRORLOG || rm $ERRORLOG
echo "end."
